var TAFFY,exports,T;!function(){"use strict";var a,b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w;if(!TAFFY)for(e="2.7",f=1,g="000000",h=1e3,i={},j=function(a){return TAFFY.isArray(a)||TAFFY.isObject(a)?a:JSON.parse(a)},s=function(a,b){return t(a,function(a){return b.indexOf(a)>=0})},t=function(a,b,c){var d=[];return null==a?d:Array.prototype.filter&&a.filter===Array.prototype.filter?a.filter(b,c):(k(a,function(a,e,f){b.call(c,a,e,f)&&(d[d.length]=a)}),d)},w=function(a){return"[object RegExp]"===Object.prototype.toString.call(a)},v=function(a){var b=T.isArray(a)?[]:T.isObject(a)?{}:null;if(null===a)return a;for(var c in a)b[c]=w(a[c])?a[c].toString():T.isArray(a[c])||T.isObject(a[c])?v(a[c]):a[c];return b},u=function(a){var b=JSON.stringify(a);return null===b.match(/regex/)?b:JSON.stringify(v(a))},k=function(a,b,c){var d,e,f,g;if(a&&(T.isArray(a)&&1===a.length||!T.isArray(a)))b(T.isArray(a)?a[0]:a,0);else for(f=0,a=T.isArray(a)?a:[a],g=a.length;g>f&&(e=a[f],T.isUndefined(e)&&!c||(d=b(e,f),d!==T.EXIT));f++);},l=function(a,b){var c,d,e=0;for(d in a)if(a.hasOwnProperty(d)&&(c=b(a[d],d,e++),c===T.EXIT))break},i.extend=function(a,b){i[a]=function(){return b.apply(this,arguments)}},m=function(a){var b;return T.isString(a)&&/[t][0-9]*[r][0-9]*/i.test(a)?!0:T.isObject(a)&&a.___id&&a.___s?!0:T.isArray(a)?(b=!0,k(a,function(a){return m(a)?void 0:(b=!1,TAFFY.EXIT)}),b):!1},o=function(a,b){var c=!0;return k(b,function(b){switch(T.typeOf(b)){case"function":if(!b.apply(a))return c=!1,TAFFY.EXIT;break;case"array":c=1===b.length?o(a,b[0]):2===b.length?o(a,b[0])||o(a,b[1]):3===b.length?o(a,b[0])||o(a,b[1])||o(a,b[2]):4===b.length?o(a,b[0])||o(a,b[1])||o(a,b[2])||o(a,b[3]):!1,b.length>4&&k(b,function(b){o(a,b)&&(c=!0)})}}),c},n=function(a){var b=[];return T.isString(a)&&/[t][0-9]*[r][0-9]*/i.test(a)&&(a={___id:a}),T.isArray(a)?(k(a,function(a){b.push(n(a))}),a=function(){var a=this,c=!1;return k(b,function(b){o(a,b)&&(c=!0)}),c}):T.isObject(a)?(T.isObject(a)&&a.___id&&a.___s&&(a={___id:a.___id}),l(a,function(a,c){T.isObject(a)||(a={is:a}),l(a,function(a,d){var e,f=[];e="hasAll"===d?function(a,b){b(a)}:k,e(a,function(a){var b,e=!0;b=function(){var b,f=this[c],g="==",h="!=",i="===",j="<",k=">",l="<=",m=">=",n="!==";return"undefined"==typeof f?!1:(0===d.indexOf("!")&&d!==h&&d!==n&&(e=!1,d=d.substring(1,d.length)),b="regex"===d?a.test(f):"lt"===d||d===j?a>f:"gt"===d||d===k?f>a:"lte"===d||d===l?a>=f:"gte"===d||d===m?f>=a:"left"===d?0===f.indexOf(a):"leftnocase"===d?0===f.toLowerCase().indexOf(a.toLowerCase()):"right"===d?f.substring(f.length-a.length)===a:"rightnocase"===d?f.toLowerCase().substring(f.length-a.length)===a.toLowerCase():"like"===d?f.indexOf(a)>=0:"likenocase"===d?f.toLowerCase().indexOf(a.toLowerCase())>=0:d===i||"is"===d?f===a:d===g?f==a:d===n?f!==a:d===h?f!=a:"isnocase"===d?f.toLowerCase?f.toLowerCase()===a.toLowerCase():f===a:"has"===d?T.has(f,a):"hasall"===d?T.hasAll(f,a):"contains"===d?TAFFY.isArray(f)&&f.indexOf(a)>-1:-1!==d.indexOf("is")||TAFFY.isNull(f)||TAFFY.isUndefined(f)||TAFFY.isObject(a)||TAFFY.isArray(a)?T[d]&&T.isFunction(T[d])&&0===d.indexOf("is")?T[d](f)===a:T[d]&&T.isFunction(T[d])?T[d](f,a):!1:a===f[d],b=b&&!e?!1:b||e?b:!0)},f.push(b)}),1===f.length?b.push(f[0]):b.push(function(){var a=this,b=!1;return k(f,function(c){c.apply(a)&&(b=!0)}),b})})}),a=function(){var a=this,c=!0;return c=(1!==b.length||b[0].apply(a))&&(2!==b.length||b[0].apply(a)&&b[1].apply(a))&&(3!==b.length||b[0].apply(a)&&b[1].apply(a)&&b[2].apply(a))&&(4!==b.length||b[0].apply(a)&&b[1].apply(a)&&b[2].apply(a)&&b[3].apply(a))?!0:!1,b.length>4&&k(b,function(b){o(a,b)||(c=!1)}),c}):T.isFunction(a)?a:void 0},q=function(a,b){var c=function(a,c){var d=0;return T.each(b,function(b){var e,f,g,h,i;if(e=b.split(" "),f=e[0],g=1===e.length?"logical":e[1],"logical"===g)h=p(a[f]),i=p(c[f]),T.each(h.length<=i.length?h:i,function(a,b){return h[b]<i[b]?(d=-1,TAFFY.EXIT):h[b]>i[b]?(d=1,TAFFY.EXIT):void 0});else if("logicaldesc"===g)h=p(a[f]),i=p(c[f]),T.each(h.length<=i.length?h:i,function(a,b){return h[b]>i[b]?(d=-1,TAFFY.EXIT):h[b]<i[b]?(d=1,TAFFY.EXIT):void 0});else{if("asec"===g&&a[f]<c[f])return d=-1,T.EXIT;if("asec"===g&&a[f]>c[f])return d=1,T.EXIT;if("desc"===g&&a[f]>c[f])return d=-1,T.EXIT;if("desc"===g&&a[f]<c[f])return d=1,T.EXIT}return 0===d&&"logical"===g&&h.length<i.length?d=-1:0===d&&"logical"===g&&h.length>i.length?d=1:0===d&&"logicaldesc"===g&&h.length>i.length?d=-1:0===d&&"logicaldesc"===g&&h.length<i.length&&(d=1),0!==d?T.EXIT:void 0}),d};return a&&a.push?a.sort(c):a},function(){var a={},b=0;p=function(c){return b>h&&(a={},b=0),a["_"+c]||function(){var d,e,f,g=String(c),h=[],i="_",j="";for(d=0,e=g.length;e>d;d++)f=g.charCodeAt(d),f>=48&&57>=f||46===f?("n"!==j&&(j="n",h.push(i.toLowerCase()),i=""),i+=g.charAt(d)):("s"!==j&&(j="s",h.push(parseFloat(i)),i=""),i+=g.charAt(d));return h.push("n"===j?parseFloat(i):i.toLowerCase()),h.shift(),a["_"+c]=h,b++,h}()}}(),r=function(){this.context({results:this.getDBI().query(this.context())})},i.extend("filter",function(){var a=TAFFY.mergeObj(this.context(),{run:null}),b=[];return k(a.q,function(a){b.push(a)}),a.q=b,k(arguments,function(b){a.q.push(n(b)),a.filterRaw.push(b)}),this.getroot(a)}),i.extend("order",function(a){a=a.split(",");var b,c=[];return k(a,function(a){c.push(a.replace(/^\s*/,"").replace(/\s*$/,""))}),b=TAFFY.mergeObj(this.context(),{sort:null}),b.order=c,this.getroot(b)}),i.extend("limit",function(a){var b,c=TAFFY.mergeObj(this.context(),{});return c.limit=a,c.run&&c.sort&&(b=[],k(c.results,function(c,d){return d+1>a?TAFFY.EXIT:void b.push(c)}),c.results=b),this.getroot(c)}),i.extend("start",function(a){var b,c=TAFFY.mergeObj(this.context(),{});return c.start=a,c.run&&c.sort&&!c.limit?(b=[],k(c.results,function(c,d){d+1>a&&b.push(c)}),c.results=b):c=TAFFY.mergeObj(this.context(),{run:null,start:a}),this.getroot(c)}),i.extend("update",function(a,b,c){var d,e=!0,f={},g=arguments;return!TAFFY.isString(a)||2!==arguments.length&&3!==arguments.length?(f=a,2===g.length&&(e=b)):(f[a]=b,3===arguments.length&&(e=c)),d=this,r.call(this),k(this.context().results,function(a){var b=f;TAFFY.isFunction(b)?b=b.apply(TAFFY.mergeObj(a,{})):T.isFunction(b)&&(b=b(TAFFY.mergeObj(a,{}))),TAFFY.isObject(b)&&d.getDBI().update(a.___id,b,e)}),this.context().results.length&&this.context({run:null}),this}),i.extend("remove",function(a){var b=this,c=0;return r.call(this),k(this.context().results,function(a){b.getDBI().remove(a.___id),c++}),this.context().results.length&&(this.context({run:null}),b.getDBI().removeCommit(a)),c}),i.extend("count",function(){return r.call(this),this.context().results.length}),i.extend("callback",function(a,b){if(a){var c=this;setTimeout(function(){r.call(c),a.call(c.getroot(c.context()))},b||0)}return null}),i.extend("get",function(){return r.call(this),this.context().results}),i.extend("stringify",function(){return JSON.stringify(this.get())}),i.extend("first",function(){return r.call(this),this.context().results[0]||!1}),i.extend("last",function(){return r.call(this),this.context().results[this.context().results.length-1]||!1}),i.extend("sum",function(){var a=0,b=this;return r.call(b),k(arguments,function(c){k(b.context().results,function(b){a+=b[c]||0})}),a}),i.extend("min",function(a){var b=null;return r.call(this),k(this.context().results,function(c){(null===b||c[a]<b)&&(b=c[a])}),b}),function(){var a=function(){var a,b,c;return a=function(a,b,c){var d,e,f;switch(2===c.length?(d=a[c[0]],f="===",e=b[c[1]]):(d=a[c[0]],f=c[1],e=b[c[2]]),f){case"===":return d===e;case"!==":return d!==e;case"<":return e>d;case">":return d>e;case"<=":return e>=d;case">=":return d>=e;case"==":return d==e;case"!=":return d!=e;default:throw String(f)+" is not supported"}},b=function(a,b){var c,d,e={};for(c in a)a.hasOwnProperty(c)&&(e[c]=a[c]);for(c in b)b.hasOwnProperty(c)&&"___id"!==c&&"___s"!==c&&(d=TAFFY.isUndefined(e[c])?"":"right_",e[d+String(c)]=b[c]);return e},c=function(c){var d,e,f=arguments,g=f.length,h=[];if("function"!=typeof c.filter){if(!c.TAFFY)throw"TAFFY DB or result not supplied";d=c()}else d=c;return this.context({results:this.getDBI().query(this.context())}),TAFFY.each(this.context().results,function(c){d.each(function(d){var i,j=!0;a:for(e=1;g>e&&(i=f[e],j="function"==typeof i?i(c,d):"object"==typeof i&&i.length?a(c,d,i):!1,j);e++);j&&h.push(b(c,d))})}),TAFFY(h)()}}();i.extend("join",a)}(),i.extend("max",function(a){var b=null;return r.call(this),k(this.context().results,function(c){(null===b||c[a]>b)&&(b=c[a])}),b}),i.extend("select",function(){var a=[],b=arguments;return r.call(this),1===arguments.length?k(this.context().results,function(c){a.push(c[b[0]])}):k(this.context().results,function(c){var d=[];k(b,function(a){d.push(c[a])}),a.push(d)}),a}),i.extend("distinct",function(){var a=[],b=arguments;return r.call(this),1===arguments.length?k(this.context().results,function(c){var d=c[b[0]],e=!1;k(a,function(a){return d===a?(e=!0,TAFFY.EXIT):void 0}),e||a.push(d)}):k(this.context().results,function(c){var d=[],e=!1;k(b,function(a){d.push(c[a])}),k(a,function(a){var c=!0;return k(b,function(b,e){return d[e]!==a[e]?(c=!1,TAFFY.EXIT):void 0}),c?(e=!0,TAFFY.EXIT):void 0}),e||a.push(d)}),a}),i.extend("supplant",function(a,b){var c=[];return r.call(this),k(this.context().results,function(b){c.push(a.replace(/\{([^\{\}]*)\}/g,function(a,c){var d=b[c];return"string"==typeof d||"number"==typeof d?d:a}))}),b?c:c.join("")}),i.extend("each",function(a){return r.call(this),k(this.context().results,a),this}),i.extend("map",function(a){var b=[];return r.call(this),k(this.context().results,function(c){b.push(a(c))}),b}),T=function(a){var b,c,d,e=[],h={},p=1,r={template:!1,onInsert:!1,onUpdate:!1,onRemove:!1,onDBChange:!1,storageName:!1,forcePropertyCase:null,cacheSize:100,name:""},s=new Date,t=0,v=0,w={};return c=function(a){var b=[],d=!1;return 0===a.length?e:(k(a,function(a){T.isString(a)&&/[t][0-9]*[r][0-9]*/i.test(a)&&e[h[a]]&&(b.push(e[h[a]]),d=!0),T.isObject(a)&&a.___id&&a.___s&&e[h[a.___id]]&&(b.push(e[h[a.___id]]),d=!0),T.isArray(a)&&k(a,function(a){k(c(a),function(a){b.push(a)})})}),d&&b.length>1&&(b=[]),b)},b={dm:function(a){return a&&(s=a,w={},t=0,v=0),r.onDBChange&&setTimeout(function(){r.onDBChange.call(e)},0),r.storageName&&setTimeout(function(){localStorage.setItem("taffy_"+r.storageName,JSON.stringify(e))}),s},insert:function(a,c){var i=[],m=[],n=j(a);return k(n,function(a,d){var j,n;return T.isArray(a)&&0===d?(k(a,function(a){i.push("lower"===r.forcePropertyCase?a.toLowerCase():"upper"===r.forcePropertyCase?a.toUpperCase():a)}),!0):(T.isArray(a)?(j={},k(a,function(a,b){j[i[b]]=a}),a=j):T.isObject(a)&&r.forcePropertyCase&&(n={},l(a,function(b,c){n["lower"===r.forcePropertyCase?c.toLowerCase():"upper"===r.forcePropertyCase?c.toUpperCase():c]=a[c]}),a=n),p++,a.___id="T"+String(g+f).slice(-6)+"R"+String(g+p).slice(-6),a.___s=!0,m.push(a.___id),r.template&&(a=T.mergeObj(r.template,a)),e.push(a),h[a.___id]=e.length-1,r.onInsert&&(c||TAFFY.isUndefined(c))&&r.onInsert.call(a),void b.dm(new Date))}),d(m)},sort:function(a){return e=q(e,a.split(",")),h={},k(e,function(a,b){h[a.___id]=b}),b.dm(new Date),!0},update:function(a,c,d){var f,g,i,j,k={};r.forcePropertyCase&&(l(c,function(a,b){k["lower"===r.forcePropertyCase?b.toLowerCase():"upper"===r.forcePropertyCase?b.toUpperCase():b]=a}),c=k),f=e[h[a]],g=T.mergeObj(f,c),i={},j=!1,l(g,function(a,b){(TAFFY.isUndefined(f[b])||f[b]!==a)&&(i[b]=a,j=!0)}),j&&(e[h[a]]=g,b.dm(new Date),r.onUpdate&&(d||TAFFY.isUndefined(d))&&r.onUpdate.call(g,f,i))},remove:function(a){e[h[a]].___s=!1},triggerOnremove:function(){r.onRemove.call()},removeCommit:function(a){var c;for(c=e.length-1;c>-1;c--)e[c].___s||(r.onRemove&&(a||TAFFY.isUndefined(a))&&r.onRemove.call(e[c]),h[e[c].___id]=void 0,e.splice(c,1));h={},k(e,function(a,b){h[a.___id]=b}),b.dm(new Date)},query:function(a){var d,f,g,h,i,j;if(r.cacheSize&&(f="",k(a.filterRaw,function(a){return T.isFunction(a)?(f="nocache",TAFFY.EXIT):void 0}),""===f&&(f=u(T.mergeObj(a,{q:!1,run:!1,sort:!1})))),!a.results||!a.run||a.run&&b.dm()>a.run){if(g=[],r.cacheSize&&w[f])return w[f].i=t++,w[f].results;0===a.q.length&&0===a.index.length?(k(e,function(a){g.push(a)}),d=g):(h=c(a.index),k(h,function(b){(0===a.q.length||o(b,a.q))&&g.push(b)}),d=g)}else d=a.results;return!(a.order.length>0)||a.run&&a.sort||(d=q(d,a.order)),d.length&&(a.limit&&a.limit<d.length||a.start)&&(i=[],k(d,function(b,c){if(!a.start||a.start&&c+1>=a.start)if(a.limit){if(j=a.start?c+1-a.start:c,j<a.limit)i.push(b);else if(j>a.limit)return TAFFY.EXIT}else i.push(b)}),d=i),r.cacheSize&&"nocache"!==f&&(v++,setTimeout(function(){var a,b;v>=2*r.cacheSize&&(v=0,a=t-r.cacheSize,b={},l(function(c,d){c.i>=a&&(b[d]=c)}),w=b)},0),w[f]={i:t++,results:d}),d}},d=function(){var a,c;return a=TAFFY.mergeObj(TAFFY.mergeObj(i,{insert:void 0}),{getDBI:function(){return b},getroot:function(a){return d.call(a)},context:function(a){return a&&(c=TAFFY.mergeObj(c,a.hasOwnProperty("results")?TAFFY.mergeObj(a,{run:new Date,sort:new Date}):a)),c},extend:void 0}),c=this&&this.q?this:{limit:!1,start:!1,q:[],filterRaw:[],index:[],order:[],results:!1,run:null,sort:null,settings:r},k(arguments,function(a){m(a)?c.index.push(a):c.q.push(n(a)),c.filterRaw.push(a)}),a},f++,a&&b.insert(a),d.insert=b.insert,d.merge=function(a,c,e){var f={},g=[],h={};return e=e||!1,c=c||"id",k(a,function(a){var h;f[c]=a[c],g.push(a[c]),h=d(f).first(),h?b.update(h.___id,a,e):b.insert(a,e)}),h[c]=g,d(h)},d.triggerOnremove=function(){b.triggerOnremove()},d.TAFFY=!0,d.sort=b.sort,d.settings=function(a){return a&&(r=TAFFY.mergeObj(r,a),a.template&&d().update(a.template)),r},d.store=function(a){var b,c=!1;return localStorage&&(a&&(b=localStorage.getItem("taffy_"+a),b&&b.length>0&&(d.insert(b),c=!0),e.length>0&&setTimeout(function(){localStorage.setItem("taffy_"+r.storageName,JSON.stringify(e))})),d.settings({storageName:a})),d},d},TAFFY=T,T.each=k,T.eachin=l,T.extend=i.extend,TAFFY.EXIT="TAFFYEXIT",TAFFY.mergeObj=function(a,b){var c={};return l(a,function(b,d){c[d]=a[d]}),l(b,function(a,d){c[d]=b[d]}),c},TAFFY.has=function(a,b){var c,d=!1;if(a.TAFFY)return d=a(b),d.length>0?!0:!1;switch(T.typeOf(a)){case"object":if(T.isObject(b))l(b,function(c,e){return d!==!0||T.isUndefined(a[e])||!a.hasOwnProperty(e)?(d=!1,TAFFY.EXIT):void(d=T.has(a[e],b[e]))});else if(T.isArray(b))k(b,function(c,e){return d=T.has(a,b[e]),d?TAFFY.EXIT:void 0});else if(T.isString(b))return TAFFY.isUndefined(a[b])?!1:!0;return d;case"array":if(T.isObject(b))k(a,function(c,e){return d=T.has(a[e],b),d===!0?TAFFY.EXIT:void 0});else if(T.isArray(b))k(b,function(c,e){return k(a,function(c,f){return d=T.has(a[f],b[e]),d===!0?TAFFY.EXIT:void 0}),d===!0?TAFFY.EXIT:void 0});else if(T.isString(b)||T.isNumber(b))for(d=!1,c=0;c<a.length;c++)if(d=T.has(a[c],b))return!0;return d;case"string":if(T.isString(b)&&b===a)return!0;break;default:if(T.typeOf(a)===T.typeOf(b)&&a===b)return!0}return!1},TAFFY.hasAll=function(a,b){var c,d=TAFFY;return d.isArray(b)?(c=!0,k(b,function(b){return c=d.has(a,b),c===!1?TAFFY.EXIT:void 0}),c):d.has(a,b)},TAFFY.typeOf=function(a){var b=typeof a;return"object"===b&&(a?"number"!=typeof a.length||a.propertyIsEnumerable("length")||(b="array"):b="null"),b},TAFFY.getObjectKeys=function(a){var b=[];return l(a,function(a,c){b.push(c)}),b.sort(),b},TAFFY.isSameArray=function(a,b){return TAFFY.isArray(a)&&TAFFY.isArray(b)&&a.join(",")===b.join(",")?!0:!1},TAFFY.isSameObject=function(a,b){var c=TAFFY,d=!0;return c.isObject(a)&&c.isObject(b)&&c.isSameArray(c.getObjectKeys(a),c.getObjectKeys(b))?l(a,function(e,f){return c.isObject(a[f])&&c.isObject(b[f])&&c.isSameObject(a[f],b[f])||c.isArray(a[f])&&c.isArray(b[f])&&c.isSameArray(a[f],b[f])||a[f]===b[f]?void 0:(d=!1,TAFFY.EXIT)}):d=!1,d},a=["String","Number","Object","Array","Boolean","Null","Function","Undefined"],b=function(a){return function(b){return TAFFY.typeOf(b)===a.toLowerCase()?!0:!1}},c=0;c<a.length;c++)d=a[c],TAFFY["is"+d]=b(d)}(),"object"==typeof exports&&(exports.taffy=TAFFY);